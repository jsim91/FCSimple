% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/prepare_fcview.R
\name{fcs_prepare_fcview_object}
\alias{fcs_prepare_fcview_object}
\title{Prepare FCSimple Object for FCView App Upload}
\usage{
fcs_prepare_fcview_object(
  fcs_join_obj,
  downsample_size = NULL,
  clustering_algorithm = NULL,
  output_dir = NULL,
  file_name = NULL,
  keep_fields = c("data", "source", "metadata", "run_date", "cluster", "umap", "tsne",
    "cluster_heatmap", "cluster_mapping", "metadata_sample")
)
}
\arguments{
\item{fcs_join_obj}{A list returned by FCSimple workflow functions (e.g., fcs_join,
fcs_cluster, fcs_reduce_dimensions), containing at minimum:
\itemize{
\item \code{data}: numeric matrix of events × channels
\item \code{source}: character vector of sample identifiers
\item \code{metadata}: data frame with sample‐level metadata
\item At least one clustering algorithm result (e.g., \code{leiden}, \code{flowsom})
}}

\item{downsample_size}{Integer or \code{NULL}; maximum number of cells to retain. If \code{NULL} (default),
no downsampling is performed. If specified, randomly samples cells and
updates all associated fields (data, source, run_date, cluster assignments,
UMAP/tSNE coordinates) accordingly.}

\item{clustering_algorithm}{Character or \code{NULL}; name of the clustering algorithm to use for the
prepared object (e.g., \code{"leiden"}, \code{"flowsom"}, \code{"louvain"}, \code{"phenograph"}).
If \code{NULL} (default), uses the first detected algorithm.
selected algorithm will be renamed to \code{"cluster"} for FCView compatibility.}

\item{output_dir}{Character or \code{NULL}; path to directory where the .RData file will be saved.
Must exist. If \code{NULL} (default), the object is not saved to disk.}

\item{file_name}{Character or \code{NULL}; name of the .RData file (extension added automatically
if not provided). If \code{NULL} (default), the object is not saved to disk.
Both \code{output_dir} and \code{file_name} must be specified to enable saving.}

\item{keep_fields}{Character vector; names of top‐level fields to retain in the prepared
object. Default includes essential FCView fields: \code{"data"}, \code{"source"},
\code{"metadata"}, \code{"run_date"}, \code{"cluster"}, \code{"umap"}, \code{"tsne"},
\code{"cluster_heatmap"}, \code{"cluster_mapping"}, and \code{"metadata_sample"}.}
}
\value{
The prepared \code{fcs_join_obj}, with non‐essential fields removed, the
selected clustering algorithm renamed to \code{"cluster"}, and metadata
tracking added. The object is returned invisibly if saved to disk,
otherwise returned explicitly.
}
\description{
Prepares a flow cytometry analysis object for upload to the FCView Shiny
application by removing non‐essential fields, optionally downsampling,
and standardizing the clustering algorithm name to 'cluster'. Can save
the prepared object as an .RData file.
}
\details{
The function performs the following steps:
\enumerate{
\item Validates required fields (\code{data}, \code{source}, \code{metadata}) are present.
\item Detects all clustering algorithms in the object.
\item Selects the specified or first detected algorithm.
\item Optionally downsamples cells (with fixed seed 123 for reproducibility),
updating all cell‐level fields: data matrix, source, run_date,
cluster assignments, and UMAP/tSNE coordinates.
\item Renames the selected clustering algorithm to \code{"cluster"} and its heatmap
to \code{"cluster_heatmap"} (required for FCView app compatibility).
\item Removes all other clustering algorithms and their heatmaps.
\item Filters the object to retain only fields specified in \code{keep_fields}.
\item Cleans up cluster and heatmap structures to keep only essential elements:
\itemize{
\item For \code{cluster}: keeps \code{clusters}, \code{settings}, \code{abundance}, \code{counts}
\item For \code{cluster_heatmap}: keeps \code{heatmap_tile_data}, \code{population_size}, \code{rep_used}
}
\item Ensures data types match FCView expectations (data as matrix, coordinates
as data frames).
\item Adds metadata tracking: \code{fcview_prepared}, \code{fcview_prep_time},
\code{fcview_clustering_algorithm}, and optionally \code{fcview_downsampled}.
\item If \code{output_dir} and \code{file_name} are provided, saves the object as
\code{fcs_data} in an .RData file and reports file size.
}
}
\examples{
\dontrun{
  # Basic preparation without saving (use packaged example files)
  files <- FCSimple::fcs_load_data()
  joined <- FCSimple::fcs_join(files)
  clustered <- FCSimple::fcs_cluster(joined, algorithm = "leiden")
  reduced <- FCSimple::fcs_reduce_dimensions(clustered, algorithm = "umap")

  prepared <- FCSimple::fcs_prepare_fcview_object(reduced)

  # Prepare with downsampling to 50,000 cells
  prepared_ds <- FCSimple::fcs_prepare_fcview_object(
    reduced,
    downsample_size = 50000
  )

  # Prepare and save to file
  prepared_saved <- FCSimple::fcs_prepare_fcview_object(
    reduced,
    downsample_size = 100000,
    clustering_algorithm = "leiden",
    output_dir = "output/fcview",
    file_name = "my_analysis_fcview"
  )

  # Prepare with specific algorithm selection
  prepared_flowsom <- FCSimple::fcs_prepare_fcview_object(
    reduced,
    clustering_algorithm = "flowsom",
    output_dir = getwd(),
    file_name = "flowsom_analysis.RData"
  )
}

}
\seealso{
FCSimple::fcs_join, FCSimple::fcs_cluster, FCSimple::fcs_reduce_dimensions,
FCSimple::fcs_cluster_heatmap
}
