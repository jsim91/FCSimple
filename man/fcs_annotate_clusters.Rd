% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/fcs_annotate_clusters.R
\name{fcs_annotate_clusters}
\alias{fcs_annotate_clusters}
\title{Annotate Clusters with Cell Type Labels}
\usage{
fcs_annotate_clusters(
  fcs_join_obj,
  annotations,
  clustering_algorithm = NULL,
  overwrite = TRUE
)
}
\arguments{
\item{fcs_join_obj}{An FCSimple analysis object (list) containing at minimum a clustering
result with a \code{clusters} vector (e.g. from \code{FCSimple::fcs_cluster()}).
The clustering result must be stored under a recognized algorithm name
(\code{"leiden"}, \code{"flowsom"}, \code{"louvain"}, \code{"phenograph"}) or \code{"cluster"}.}

\item{annotations}{A named list mapping cell type labels to one or more cluster IDs.
Names are the cell type labels; values are integer or character vectors
of cluster IDs to assign to that label. Example:
\preformatted{
  list(
    "T cell" = c(1, 2, 3),
    "B cell" = c(4, 6, 7),
    "NK"     = 5
  )
  }
Not all clusters need to be annotated. Any cluster not referenced will
receive a \code{NA} value in the \code{celltype} column of the mapping, indicating
it is unassigned. The FCView annotation tab treats \code{NA}-mapped clusters
as pending assignment and will not pre-fill a cell type for them.}

\item{clustering_algorithm}{Character or \code{NULL} (default). Name of the clustering algorithm whose
cluster IDs are referenced in \code{annotations}
(e.g. \code{"leiden"}, \code{"flowsom"}, \code{"cluster"}). If \code{NULL}, the first
detected algorithm is used. The resulting mapping is stored on the
object under this name: e.g. \code{"leiden"} → \code{leiden_mapping}. This
allows multiple algorithm mappings to coexist on the same object.}

\item{overwrite}{Logical; if \code{TRUE} (default), replaces any existing \verb{\{algorithm\}_mapping}
element for the selected algorithm. If \code{FALSE} and the mapping already
exists, an error is raised.}
}
\value{
The input \code{fcs_join_obj} with a \code{cluster_mapping} data frame added (or
replaced), and an updated \code{object_history} entry.
}
\description{
Assigns cell type names to clusters in an FCSimple analysis object by
building a \verb{\{algorithm\}_mapping} data frame (e.g. \code{leiden_mapping},
\code{flowsom_mapping}). This mapping is used by the FCView Shiny application
to populate the Annotation tab and enable cell-type-level analysis across
all downstream tabs.
}
\details{
The function:
\enumerate{
\item Validates that \code{annotations} is a non-empty named list.
\item Detects or validates the specified clustering algorithm.
\item Determines the set of valid cluster IDs from the cluster vector.
\item Warns about any annotated cluster IDs not present in the data.
\item Warns about any cluster IDs assigned to multiple cell types
(each cluster can only belong to one cell type; the first
assignment wins).
\item Builds a two-column data frame with columns \code{cluster} (integer)
and \code{celltype} (character), one row per cluster in the data,
sorted by cluster ID.
\item Clusters not present in \code{annotations} receive \code{NA} in the
\code{celltype} column, flagging them as unassigned.
\item Stores the result as \verb{fcs_join_obj$\{algorithm\}_mapping}
(e.g. \code{leiden_mapping}, \code{flowsom_mapping}).
}

The FCView annotation tab will not pre-fill a cell type for \code{NA}-mapped
clusters, allowing the user to assign them interactively in the app.
}
\examples{
\dontrun{
  files   <- FCSimple::fcs_example_files()
  joined  <- FCSimple::fcs_join(files)
  clustered <- FCSimple::fcs_cluster(joined, algorithm = "leiden")

  # Annotate a subset of clusters (others left un-named)
  annotated <- FCSimple::fcs_annotate_clusters(
    clustered,
    annotations = list(
      "CD4 T cell" = c(1, 3),
      "CD8 T cell" = c(2, 5),
      "B cell"     = 4,
      "NK"         = 6
    )
  )

  annotated$cluster_mapping
  #   cluster    celltype
  # 1       1  CD4 T cell
  # 2       2  CD8 T cell
  # 3       3  CD4 T cell
  # 4       4      B cell
  # 5       5  CD8 T cell
  # 6       6          NK

  # Prepare for FCView (cluster_mapping is preserved automatically)
  # The mapping is stored as leiden_mapping because clustering_algorithm
  # defaults to the first detected algorithm (leiden here).
  names(annotated)  # includes "leiden_mapping"

  # Multiple algorithms: annotate each separately
  clustered2 <- FCSimple::fcs_cluster(clustered, algorithm = "flowsom")
  annotated2 <- FCSimple::fcs_annotate_clusters(
    clustered2,
    annotations = list("T cell" = c(1, 2), "B cell" = 3),
    clustering_algorithm = "flowsom"
  )
  # annotated2$flowsom_mapping is now available alongside leiden_mapping

  # Prepare for FCView — pass the algorithm whose mapping you want to use:
  prepared <- FCSimple::fcs_prepare_fcview_object(
    annotated,
    clustering_algorithm = "leiden"
  )
  # prepared$cluster_mapping is leiden_mapping renamed for the app
}

}
\seealso{
FCSimple::fcs_cluster, FCSimple::fcs_prepare_fcview_object
}
