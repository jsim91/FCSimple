% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/fcs_pca.R
\name{fcs_pca}
\alias{fcs_pca}
\title{Principal Component Analysis of Flow Cytometry Data}
\usage{
fcs_pca(
  fcs_join_obj,
  pca_method = c("prcomp"),
  variance_threshold = 0.975,
  num_pc = NULL,
  apply_scaling = TRUE
)
}
\arguments{
\item{fcs_join_obj}{A list returned by FCSimple::fcs_join(), optionally augmented by
fcs_batch_correction, containing at minimum:
\itemize{
\item \code{data}: numeric matrix of events × channels
\item if batch correction was applied, \code{batch_correction$data}
}}

\item{pca_method}{Character; PCA method to use. Currently only \code{"prcomp"} (default).}

\item{variance_threshold}{Numeric or \code{NULL}; threshold for cumulative variance explained
(range 0–1, inclusive). When \code{num_pc} is \code{NULL} (the default), the
function automatically selects the minimum number of PCs needed to reach
or exceed this threshold. Defaults to \code{0.975}. Ignored when \code{num_pc} is
explicitly supplied.}

\item{num_pc}{Integer or \code{NULL} (default); number of principal components to retain.
When provided, overrides \code{variance_threshold}. If both \code{variance_threshold}
and \code{num_pc} are \code{NULL}, the function displays a plot of 1 – cumulative
variance vs. PC, prompts for input (e.g. a number or \code{"drawN"} to draw a
vertical line at PC N), and repeats until a valid integer is provided.}

\item{apply_scaling}{Logical; if \code{TRUE} (default), centers and scales data before PCA.
If \code{FALSE}, passes \code{center = FALSE} and \code{scale. = FALSE} to \code{prcomp}.}
}
\value{
The original \code{fcs_join_obj} augmented with a new element \code{pca}, a list with:
\itemize{
\item \code{pca_data}: numeric matrix (events × selected PCs)
\item \code{PCs}: integer number of PCs retained
\item \code{cumulative_variance}: numeric vector of cumulative variance explained
\item \code{pca_method}: character string of the method used
\item \code{elbow_plot}: a ggplot2 object illustrating cumulative variance and
highlighting the chosen PC count
}
}
\description{
Performs PCA on expression data (using batch‐corrected data if available)
and stores the selected principal components, variance explained, and an
elbow plot. If \code{num_pc} is \code{NULL}, shows an interactive plot of
(1 – cumulative variance) vs. PC and prompts the user to enter the number
of PCs to retain.
}
\details{
The function:
\enumerate{
\item Detects and uses \code{batch_correction$data} if present.
\item Runs \code{stats::prcomp} on the selected data with a fixed seed.
\item Computes cumulative variance explained (\code{cumVar}) and its complement.
\item Determines the number of PCs to retain:
\itemize{
\item If \code{num_pc} is specified, uses that exact number (overrides threshold)
\item Else if \code{variance_threshold} is specified, selects the minimum number
of PCs needed to reach or exceed that proportion of variance (0–1)
\item Else displays an interactive inverse‐variance plot, captures user
input, and highlights the chosen PC on the plot
}
\item Extracts the selected principal components into \code{pca_data}.
\item Builds an elbow plot (\code{ggplot2}) marking the selected PCs.
\item Appends a message to \code{object_history} noting whether PCA was run on
corrected or uncorrected data and the timestamp.
}
}
\examples{
\dontrun{
  files   <- list(ff1, ff2)
  joined  <- FCSimple::fcs_join(files)

  # Interactive PCA: choose number of PCs via prompt
  pca_obj <- FCSimple::fcs_pca(joined)

  # Run PCA and keep first 5 PCs directly
  pca5 <- FCSimple::fcs_pca(joined, num_pc = 5)

  # Automatically select PCs to explain 95\% of variance
  pca95 <- FCSimple::fcs_pca(joined, variance_threshold = 0.95)

  # Run PCA without centering/scaling
  pca_raw <- FCSimple::fcs_pca(joined, num_pc = 10, apply_scaling = FALSE)
}

}
\seealso{
stats::prcomp, ggplot2::ggplot, FCSimple::fcs_join,
FCSimple::fcs_batch_correction
}
